<main>
    <div class="orders-container">
        <div class="side-panel">
            <div class="panel-header">Actions</div>
            <button (click)="onUpdateList()">Update List</button><br>
            <button (click)="copyEmails()">Copy email addresses</button><br>
            <button (click)="copyAddresses()">Copy postal addresses</button><br>
            <button (click)="newOrder()">New manual order</button><br>

            <div class="panel-header">Filters</div>

            <label for="textSearch">Search: </label>
            <input [(ngModel)]="textSearch" type="text" id="textSearch" name="textSearch" (keyup)="onUpdateList()"><br>

            <div class="filter-table"> 
                <div class="filter-table-left">
                    By Type<br>
                    <input [(ngModel)]="filterOnline" type="checkbox" id="filterOnline" name="filterOnline" value="filterOnline" (ngModelChange)="onUpdateList()">
                    <label for="filterOnline">Online</label><br>
                    <input [(ngModel)]="filterManual" type="checkbox" id="filterManual" name="filterManual" value="filterManual" (ngModelChange)="onUpdateList()">
                    <label for="filterManual">Manual</label><br>
                    <input [(ngModel)]="filterTest" type="checkbox" id="filterTest" name="filterTest" value="filterTest" (ngModelChange)="onUpdateList()">
                    <label for="filterTest">Test</label><br>
                </div>
                <div class="filter-table-right">
                    By Status<br>
                    <select [(ngModel)]="filterStatus" name="selectStatus" id="selectStatus" (change)="onUpdateList()">
                        <option value="orderCompleted"> Completed</option>
                        <option value="readyToPost">    Ready to Post</option>
                        <option value="posted">         Posted</option>
                        <option value="returned">       Returned</option>
                        <option value="refunded">       Refunded</option>
                    </select><br>
                </div>
            </div>
            <button (click)="resetFilters()">Reset Filters</button><br>

            <div class="panel-header">Summary</div>
            <table class="summary-table">
                <tbody>
                    <tr>
                        <td>Number of Orders</td>
                        <td>{{orders.length}}</td>
                    </tr>
                    <tr>
                        <td>Number of Copies</td>
                        <td>{{numberOfCopies}}</td>
                    </tr> 
                    <tr>
                        <td>Order Value</td>
                        <td>Â£{{orderValue}}</td>
                    </tr>  
                </tbody>                  
            </table>
        </div>

        <div class="content">
        

        @for (order of orders; track order) {
            <!-- @let isActionNeeded = false; -->
            <!-- @let isActionNeeded = 
                (!!order.timeStamps?.orderCompleted && !order.timeStamps?.readyToPost) || 
                (!!order.timeStamps?.readyToPost && !order.timeStamps?.posted) || 
                (!!order.timeStamps?.returned && !order.timeStamps?.refunded); -->

            <div class="order-table">
                <div class="order-line first-line" >
                    <div class="title" [ngClass]="order.isAction ? 'red' : 'grey'">Order Number</div>
                    <div class="value" [ngClass]="order.isAction ? 'red' : 'grey'">{{ order.orderNumber }}</div>
                    @if (order.endPoint === 'manual') {
                        <a class="action" [routerLink]="'manual/'+order.orderNumber">Edit Order</a>
                        <button (click)="onDeactivate(order.orderNumber!)">Deactivate</button>
                    }
                </div>
                <div class="order-line">
                    <div class="title">PayPal Order ID</div>
                    <div class="value">{{ order.payPalOrderId ?? '' }}</div>
                </div>            
                @if (order.timeStamps?.orderCreated) {
                    <div class="order-line">
                        <div class="title">Order Created</div>
                        <div class="value">{{order.timeStamps?.orderCreated}}</div>
                    </div>
                }
                @if (order.timeStamps?.orderCompleted) {
                    <div class="order-line">
                        <div class="title" [ngClass]="!order.timeStamps?.readyToPost ? 'red' : ''">Order Completed</div>
                        <div class="value" [ngClass]="!order.timeStamps?.readyToPost ? 'red' : ''">{{order.timeStamps?.orderCompleted}}</div>
                        @if (!order.timeStamps?.readyToPost) {
                            <div class="action">
                                <button (click)="onSetStatus(order.orderNumber, 'readyToPost')">Ready to Post</button>
                            </div>
                            <!-- <div class="button"><button (click)="onSetStatus(order.orderNumber, 'readyToPost')">Ready to Post</button></div> -->
                        }
                    </div>
                }
                @if (order.timeStamps?.readyToPost) {
                    <div class="order-line">
                        <div class="title" [ngClass]="!order.timeStamps?.posted ? 'red' : ''">Ready to Post</div>
                        <div class="value" [ngClass]="!order.timeStamps?.posted ? 'red' : ''">{{order.timeStamps?.readyToPost}}</div>
                        @if (!order.timeStamps?.posted) {
                            <div class="action">
                                <button (click)="onSetStatus(order.orderNumber, 'posted')">Posted</button>
                                <button (click)="onSetStatus(order.orderNumber, 'orderCompleted', 'readyToPost')">Undo Step</button>
                            </div>
                        }
                    </div>
                }     
                @if (order.timeStamps?.posted) {
                    <div class="order-line">
                        <div class="title">Posted</div>
                        <div class="value">{{order.timeStamps?.posted}}</div>
                        @if (!order.timeStamps?.postedEmailSent && !order.timeStamps?.returned) {
                            <div class="action">
                                <button (click)="onSendEmail(order.orderNumber)">Send Email</button>
                                <button (click)="onSetStatus(order.orderNumber, 'returned')">Returned</button>
                                <button (click)="onSetStatus(order.orderNumber, 'readyToPost', 'posted')">Undo Step</button>
                            </div>
                        }
                    </div>
                }
                @if (order.timeStamps?.postedEmailSent) {
                    <div class="order-line">
                        <div class="title">Posted Email</div>
                        <div class="value">{{order.timeStamps?.postedEmailSent}}</div>
                        @if (!order.timeStamps?.returned) {
                            <div class="action">
                                <button (click)="onSetStatus(order.orderNumber, 'returned')">Returned</button>
                            </div>
                        }
                    </div>
                }  
                @if (order.timeStamps?.returned) {
                    <div class="order-line">
                        <div class="title" [ngClass]="!order.timeStamps?.refunded ? 'red' : ''">Returned</div>
                        <div class="value" [ngClass]="!order.timeStamps?.refunded ? 'red' : ''">{{order.timeStamps?.returned}}</div>
                        @if (!order.timeStamps?.refunded) {
                            <div class="action">
                                <button (click)="onSetStatus(order.orderNumber, 'refunded')">Refunded</button>
                                <button (click)="onSetStatus(order.orderNumber, 'postedEmailSent', 'returned')">Undo Step</button>
                            </div>
                        }
                    </div>
                }
                @if (order.timeStamps?.refunded) {
                    <div class="order-line">
                        <div class="title">Refunded</div>
                        <div class="value">{{order.timeStamps?.refunded}}</div>
                        <div class="action">
                            <button (click)="onSetStatus(order.orderNumber, 'returned', 'refunded')">Undo Step</button>
                        </div>
                    </div>
                }
                <div class="order-line">
                    <div class="title">API Endpoint</div>
                    <div class="value">{{ order.endPoint }}</div>
                </div>
                <div class="order-line">
                    <div class="title">Postage Label</div>

                    <!-- Using inline styles here so that the formatting remains when copied as rich text -->
                    <div #label id="{{order.orderNumber}}" class="value">
                        <span style="font-size: 0.4em;">
                            x{{ order.items[0].quantity }}, {{ order.shippingOption }}
                        </span>
                        <br>
                        <span style="white-space: pre-line;">
                            {{ getAddress(order) }}
                        </span>
                    </div>
                    
                    <div class="action">
                        <button (click)= "copyLabel(order)">Copy Label</button>
                    </div>
                    </div>
                <div class="order-line">
                    <div class="title">Email </div>
                    <div class="value">
                        {{ order.user.email_address }}
                    </div>
                </div>
                
                <div class="order-line">
                    <div class="title">Item Cost</div>
                    <div class="value"> {{ order.costBreakdown.items | currency: 'GBP' : 'symbol' : '1.2-2' : 'en' }}</div>
                </div>
                <div class="order-line">
                    <div class="title">Discount</div>
                    <div class="value"> {{ -order.costBreakdown.discount | currency: 'GBP' : 'symbol' : '1.2-2' : 'en' }}</div>
                </div>     
                <div class="order-line">
                    <div class="title">Shipping </div>
                    <div class="value"> {{ order.costBreakdown.shipping | currency: 'GBP' : 'symbol' : '1.2-2' : 'en' }}</div>
                </div>
                <div class="order-line">
                    <div class="title">Total Cost</div>
                    <div class="value"> {{ order.costBreakdown.total | currency: 'GBP' : 'symbol' : '1.2-2' : 'en' }}</div>
                </div>                        
                <div class="order-line">
                    <div class="title">Order Note</div>
                    <div class="value"> {{ order.notes }}</div>
                </div>     
            </div>
        }
    </div>
</div>
</main>
